{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Log Analytics workspace (Sentinel)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "dceName": {
      "type": "string",
      "defaultValue": "dce-cloudappdiscovery",
      "metadata": {
        "description": "Name of the Data Collection Endpoint"
      }
    },
    "dcrName": {
      "type": "string",
      "defaultValue": "dcr-cloudappdiscovery",
      "metadata": {
        "description": "Name of the Data Collection Rule"
      }
    },
    "watchlistName": {
      "type": "string",
      "defaultValue": "CloudAppInfo",
      "metadata": {
        "description": "Name of the watchlist for Cloud App Information"
      }
    }
  },
  "variables": {
    "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
    "cloudAppsTableName": "CloudApps_CL",
    "cloudAppsUsersTableName": "CloudAppsUsers_CL"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionEndpoints",
      "apiVersion": "2022-06-01",
      "name": "[parameters('dceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "networkAcls": {
          "publicNetworkAccess": "Enabled"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('workspaceName'), '/', variables('cloudAppsTableName'))]",
      "properties": {
        "schema": {
          "name": "[variables('cloudAppsTableName')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime",
              "description": "The time the event was generated"
            },
            {
              "name": "streamId",
              "type": "string",
              "description": "Stream ID"
            },
            {
              "name": "id",
              "type": "string",
              "description": "App ID"
            },
            {
              "name": "displayName",
              "type": "string",
              "description": "App display name"
            },
            {
              "name": "tags",
              "type": "string",
              "description": "Tags (comma-separated)"
            },
            {
              "name": "riskScore",
              "type": "int",
              "description": "Risk score"
            },
            {
              "name": "lastSeenDateTime",
              "type": "datetime",
              "description": "Last seen date and time"
            },
            {
              "name": "domains",
              "type": "string",
              "description": "Domains (comma-separated)"
            },
            {
              "name": "category",
              "type": "string",
              "description": "App category"
            },
            {
              "name": "userCount",
              "type": "int",
              "description": "User count"
            },
            {
              "name": "ipAddressCount",
              "type": "int",
              "description": "IP address count"
            },
            {
              "name": "transactionCount",
              "type": "long",
              "description": "Transaction count"
            },
            {
              "name": "uploadNetworkTrafficInBytes",
              "type": "long",
              "description": "Upload network traffic in bytes"
            },
            {
              "name": "downloadNetworkTrafficInBytes",
              "type": "long",
              "description": "Download network traffic in bytes"
            },
            {
              "name": "deviceCount",
              "type": "int",
              "description": "Device count"
            }
          ]
        },
        "retentionInDays": 90
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[concat(parameters('workspaceName'), '/', variables('cloudAppsUsersTableName'))]",
      "properties": {
        "schema": {
          "name": "[variables('cloudAppsUsersTableName')]",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime",
              "description": "The time the event was generated"
            },
            {
              "name": "streamId",
              "type": "string",
              "description": "Stream ID"
            },
            {
              "name": "appId",
              "type": "string",
              "description": "App ID"
            },
            {
              "name": "appDisplayName",
              "type": "string",
              "description": "App display name"
            },
            {
              "name": "userIdentifier",
              "type": "string",
              "description": "User identifier (email or UPN)"
            }
          ]
        },
        "retentionInDays": 90
      }
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2022-06-01",
      "name": "[parameters('dcrName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('dceName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), variables('cloudAppsTableName'))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces/tables', parameters('workspaceName'), variables('cloudAppsUsersTableName'))]"
      ],
      "properties": {
        "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('dceName'))]",
        "streamDeclarations": {
          "Custom-CloudApps": {
            "columns": [
              { "name": "streamId", "type": "string" },
              { "name": "id", "type": "string" },
              { "name": "displayName", "type": "string" },
              { "name": "tags", "type": "string" },
              { "name": "riskScore", "type": "int" },
              { "name": "lastSeenDateTime", "type": "datetime" },
              { "name": "domains", "type": "string" },
              { "name": "category", "type": "string" },
              { "name": "userCount", "type": "int" },
              { "name": "ipAddressCount", "type": "int" },
              { "name": "transactionCount", "type": "long" },
              { "name": "uploadNetworkTrafficInBytes", "type": "long" },
              { "name": "downloadNetworkTrafficInBytes", "type": "long" },
              { "name": "deviceCount", "type": "int" }
            ]
          },
          "Custom-CloudAppsUsers": {
            "columns": [
              { "name": "streamId", "type": "string" },
              { "name": "appId", "type": "string" },
              { "name": "appDisplayName", "type": "string" },
              { "name": "userIdentifier", "type": "string" }
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[variables('workspaceResourceId')]",
              "name": "sentinel"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": ["Custom-CloudApps"],
            "destinations": ["sentinel"],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "[concat('Custom-', variables('cloudAppsTableName'))]"
          },
          {
            "streams": ["Custom-CloudAppsUsers"],
            "destinations": ["sentinel"],
            "transformKql": "source | extend TimeGenerated = now()",
            "outputStream": "[concat('Custom-', variables('cloudAppsUsersTableName'))]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.SecurityInsights/watchlists",
      "apiVersion": "2023-02-01",
      "name": "[parameters('watchlistName')]",
      "scope": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]",
      "properties": {
        "displayName": "Cloud App Information",
        "description": "Watchlist containing detailed information about discovered cloud applications including compliance, security features, and GDPR attributes",
        "provider": "Microsoft",
        "source": "CloudAppDiscovery",
        "itemsSearchKey": "id",
        "contentType": "text/csv",
        "numberOfLinesToSkip": 0,
        "rawContent": "\"id\",\"appId\",\"appDisplayName\",\"vendor\",\"logonUrls\",\"hostingCompany\",\"founded\",\"headquarters\",\"dataCenter\",\"holding\",\"gdprReadinessStatement\",\"dataTypes\",\"encryptionProtocol\",\"dataAtRestEncryptionMethod\",\"latestBreachDateTime\",\"domainRegistrationDateTime\",\"isSoc1Compliant\",\"isSoc2Compliant\",\"isSoc3Compliant\",\"isSoxCompliant\",\"isSsae16Compliant\",\"isCoppaCompliant\",\"isFerpaCompliant\",\"isFfiecCompliant\",\"isFinraCompliant\",\"isFismaCompliant\",\"isGaapCompliant\",\"isGlbaCompliant\",\"isHipaaCompliant\",\"isHitrustCsfCompliant\",\"isIsae3402Compliant\",\"isIso27001Compliant\",\"isIso27017Compliant\",\"isIso27018Compliant\",\"isItarCompliant\",\"isCobitCompliant\",\"csaStarLevel\",\"pciDssVersion\",\"fedRampLevel\",\"isPrivacyShieldCompliant\",\"isSp80053Compliant\",\"dataRetentionPolicy\",\"isMultiFactorAuthentication\",\"isAdminAuditTrail\",\"isTrustedCertificate\",\"isValidCertificateName\",\"isPasswordPolicyChangePasswordPeriod\",\"isPasswordPolicyCharacterCombination\",\"isPasswordPolicyPasswordHistoryAndReuse\",\"isPasswordPolicyPersonalInformationUse\",\"isPasswordPolicyPasswordLengthLimit\",\"isPenetrationTesting\",\"isDataAuditTrail\",\"isUserAuditTrail\",\"isDataClassification\",\"isDataOwnership\",\"isHttpSecurityHeadersContentSecurityPolicy\",\"isHttpSecurityHeadersStrictTransportSecurity\",\"isHttpSecurityHeadersXContentTypeOptions\",\"isHttpSecurityHeadersXFrameOptions\",\"isHttpSecurityHeadersXXssProtection\",\"isIpAddressRestriction\",\"isRememberPassword\",\"isFileSharing\",\"isSupportsSaml\",\"isDmca\",\"isUserRolesSupport\",\"isDisasterRecoveryPlan\",\"isRequiresUserAuthentication\",\"isUserCanUploadData\",\"isGdprDataProtectionImpactAssessment\",\"isGdprDataProtectionSecureCrossBorderDataTransfer\",\"isGdprDataProtectionOfficer\",\"isGdprLawfulBasisForProcessing\",\"isGdprReportDataBreaches\",\"isGdprRightToAccess\",\"isGdprRightToBeInformed\",\"isGdprRightToDataPortablility\",\"isGdprRightToErasure\",\"isGdprRightToObject\",\"isGdprRightToRectification\",\"isGdprRightToRestrictionOfProcessing\",\"isGdprRightsRelatedToAutomatedDecisionMaking\"\n\"20893\",\"20893\",\"Microsoft Exchange Online\",\"Microsoft Corporation\",\"mail.exchange.microsoft.com, login.microsoftonline.com, azure.microsoft.com/auth/signin\",\"Microsoft Azure\",\"1975\",\"US\",\"MULTIPLE\",\"public\",\"https://blogs.microsoft.com/on-the-issues/2017/02/15/get-gdpr-compliant-with-the-microsoft-cloud/\",\"documents, mediaFiles, databaseFiles, codingFiles, creditCards\",\"tls1_2\",\"aes\",\"\",\"1991-05-02T02:00:00Z\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"certification\",\"v4\",\"high\",\"true\",\"true\",\"deletedImmediately\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\",\"true\""
      }
    }
  ],
  "outputs": {
    "dceEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionEndpoints', parameters('dceName'))).logsIngestion.endpoint]"
    },
    "dcrImmutableId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Insights/dataCollectionRules', parameters('dcrName'))).immutableId]"
    },
    "cloudAppsStream": {
      "type": "string",
      "value": "Custom-CloudApps"
    },
    "cloudAppsUsersStream": {
      "type": "string",
      "value": "Custom-CloudAppsUsers"
    },
    "watchlistName": {
      "type": "string",
      "value": "[parameters('watchlistName')]"
    },
    "watchlistAlias": {
      "type": "string",
      "value": "[parameters('watchlistName')]"
    }
  }
}
